{
    "manifests": {
        "mformono/docker": {
            "manifest": {
                "copy-from-recipe": {
                    "continue/": ".continue/",
                    "etc/": "etc/",
                    "dockerignore": ".dockerignore",
                    "compose.yaml": "compose.yaml",
                    "Dockerfile": "Dockerfile"
                },
                "add-lines": [
                    {
                        "file": ".editorconfig",
                        "content": "[docker-compose{,.override}.{yaml,yml}]\n[compose{,.override}.yaml]\nindent_size = 2",
                        "position": "bottom",
                        "warn_if_missing": true
                    }
                ],
                "gitignore": [
                    "/compose.override.yaml"
                ]
            },
            "files": {
                "Dockerfile": {
                    "contents": [
                        "# syntax=docker/dockerfile:1",
                        "",
                        "# See: https://php.watch/versions",
                        "ARG PHP_VERSION=8.4.8",
                        "",
                        "# User and group settings",
                        "ARG APP_UID=1000",
                        "ARG APP_GID=${APP_UID}",
                        "",
                        "#######",
                        "# App #",
                        "#######",
                        "",
                        "FROM php:${PHP_VERSION}-fpm-bookworm AS app",
                        "",
                        "# See: https://nodejs.org/en/about/previous-releases",
                        "ARG NODE_VERSION=24.3.0",
                        "# See: https://github.com/composer/composer/releases",
                        "ARG COMPOSER_VERSION=2.8.9",
                        "# See: https://github.com/mlocati/docker-php-extension-installer/releases",
                        "ARG PHP_EXTENSION_INSTALLER_VERSION=2.8.2",
                        "",
                        "# OpenContainers labels",
                        "LABEL org.opencontainers.image.title=\"MforMono Skeleton\"",
                        "LABEL org.opencontainers.image.description=\"A customised Symfony project to create bare bones applications with php recipes\"",
                        "LABEL org.opencontainers.image.authors=\"Alexandre Balmes\"",
                        "LABEL org.opencontainers.image.source=\"https://github.com/mformono/skeleton\"",
                        "",
                        "# User and group settings (must be redeclared after FROM)",
                        "ARG APP_UID",
                        "ARG APP_GID",
                        "",
                        "SHELL [\"/bin/bash\", \"-e\", \"-o\", \"pipefail\", \"-c\"]",
                        "",
                        "# Install system packages",
                        "RUN <<EOF",
                        "",
                        "# Node Repository",
                        "curl -sSLf https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key \\",
                        "    --output /etc/apt/keyrings/node.asc",
                        "printf \"\\",
                        "Types: deb\\n\\",
                        "URIs: https://deb.nodesource.com/node_$(echo ${NODE_VERSION} | cut -d. -f1).x\\n\\",
                        "Suites: nodistro\\n\\",
                        "Components: main\\n\\",
                        "Signed-By: /etc/apt/keyrings/node.asc\\n\\",
                        "\" > /etc/apt/sources.list.d/node.sources",
                        "printf \"\\",
                        "Package: nodejs\\n\\",
                        "Pin: version ${NODE_VERSION}-*\\n\\",
                        "Pin-Priority: 1000\\n\\",
                        "\" > /etc/apt/preferences.d/node",
                        "",
                        "apt-get update --quiet",
                        "apt-get upgrade --quiet --yes --purge",
                        "apt-get install --quiet --yes --no-install-recommends --verbose-versions \\",
                        "    bash \\",
                        "    dumb-init \\",
                        "    git \\",
                        "    nodejs \\",
                        "    npm \\",
                        "    sudo \\",
                        "    wget \\",
                        "    zip \\",
                        "    unzip",
                        "apt-get clean",
                        "rm -rf /var/lib/apt/lists/*",
                        "",
                        "# Create app user and group",
                        "addgroup --gid ${APP_GID} app",
                        "adduser --home /home/app --shell /bin/bash --uid ${APP_UID} --gecos app --ingroup app --disabled-password app",
                        "",
                        "# Add app user to sudoers",
                        "echo \"app ALL=(ALL) NOPASSWD:ALL\" > /etc/sudoers.d/app",
                        "",
                        "# App",
                        "install --verbose --owner app --group app --mode 0755 --directory /app",
                        "",
                        "# Install PHP extensions installer",
                        "curl -sSLf https://github.com/mlocati/docker-php-extension-installer/releases/latest/download/install-php-extensions \\",
                        "    --output /usr/local/bin/install-php-extensions",
                        "",
                        "chmod +x /usr/local/bin/install-php-extensions",
                        "",
                        "# Install PHP extensions",
                        "install-php-extensions \\",
                        "    @composer-${COMPOSER_VERSION} \\",
                        "    intl \\",
                        "    opcache \\",
                        "    pcntl \\",
                        "    xsl \\",
                        "    zip",
                        "EOF",
                        "",
                        "###> recipes ###",
                        "###< recipes ###",
                        "",
                        "# Set working directory",
                        "WORKDIR /app",
                        "",
                        "# Official php images comes with SIGQUIT as stop signal to shut down fpm gracefully (see: https://github.com/docker-library/php/pull/816)",
                        "# For a more generic way to use this image, set the default SIGTERM docker stop signal.",
                        "STOPSIGNAL SIGTERM",
                        "",
                        "# Copy entrypoint scripts",
                        "COPY --link --chmod=755 etc/docker/entrypoints/* /usr/local/bin/",
                        "ENTRYPOINT [\"app-entrypoint\"]",
                        "",
                        "#############",
                        "# App - Dev #",
                        "#############",
                        "",
                        "FROM app AS app_dev",
                        "",
                        "# Install Xdebug",
                        "RUN <<EOF",
                        "    install-php-extensions xdebug",
                        "EOF",
                        "",
                        "# Set Xdebug mode to off by default (can be enabled via docker-compose)",
                        "ENV XDEBUG_MODE=\"off\"",
                        "",
                        "# Install Symfony CLI for development using heredoc",
                        "RUN <<EOF",
                        "    wget https://get.symfony.com/cli/installer -O - | bash",
                        "    mv /root/.symfony5/bin/symfony /usr/local/bin/symfony",
                        "    chown app:app /usr/local/bin/symfony",
                        "EOF",
                        "",
                        "USER app",
                        "",
                        "##############",
                        "# App - Prod #",
                        "##############",
                        "",
                        "FROM app AS app_prod",
                        "",
                        "ENV APP_ENV=prod",
                        "",
                        ""
                    ],
                    "executable": false
                },
                "compose.yaml": {
                    "contents": [
                        "services:",
                        "",
                        "  #######",
                        "  # App #",
                        "  #######",
                        "",
                        "  app:",
                        "    hostname: app",
                        "    build:",
                        "      target: app_dev",
                        "      args:",
                        "        - APP_UID=${APP_UID:-1000}",
                        "        - APP_GID=${APP_GID:-1000}",
                        "    entrypoint: app-php-entrypoint",
                        "    volumes:",
                        "      - ./etc/docker/php/conf.d/app.dev.ini:/usr/local/etc/php/conf.d/zz-app.ini:ro",
                        "      - ./etc/docker/php/conf.d/xdebug.ini:/usr/local/etc/php/conf.d/zz-xdebug.ini:ro",
                        "      - ./etc/docker/php/fpm.d/www.dev.conf:/usr/local/etc/php-fpm.d/zz-www.conf:ro",
                        "      - .:/app",
                        "    environment:",
                        "      - XDEBUG_MODE=off",
                        "      - XDEBUG_CLIENT_HOST=host.docker.internal",
                        "      - XDEBUG_CLIENT_PORT=9003",
                        "",
                        "  app_test:",
                        "    hostname: app_test",
                        "    build:",
                        "      target: app_dev",
                        "      args:",
                        "        - APP_UID=${APP_UID:-1000}",
                        "        - APP_GID=${APP_GID:-1000}",
                        "    entrypoint: app-php-entrypoint",
                        "    volumes:",
                        "      - ./etc/docker/php/conf.d/app.dev.ini:/usr/local/etc/php/conf.d/zz-app.ini:ro",
                        "      - ./etc/docker/php/fpm.d/www.dev.conf:/usr/local/etc/php-fpm.d/zz-www.conf:ro",
                        "      - .:/app",
                        "    environment:",
                        "      APP_ENV: \"test\""
                    ],
                    "executable": false
                },
                "continue/rules/docker-php-best-practices.md": {
                    "contents": [
                        "---",
                        "globs: \"*Dockerfile*,docker/php/**/*,docker/entrypoints/*,compose.yaml\"",
                        "description: Specialized Docker conventions for PHP and Symfony applications.",
                        "  These rules ensure optimal PHP configuration, proper development and",
                        "  production environments, efficient dependency management, and adherence to",
                        "  Symfony best practices in containerized environments.",
                        "---",
                        "",
                        "# PHP/Symfony Docker Best Practices",
                        "",
                        "1. Use official PHP images as base (php:X.Y-fpm-distribution).",
                        "2. Use Debian-based images (bookworm) for better compatibility with PHP extensions.",
                        "3. Use install-php-extensions script for PHP extension installation.",
                        "4. Install specific PHP extensions required for Symfony:",
                        "   - intl: for internationalization",
                        "   - opcache: for performance optimization",
                        "   - pcntl: for process control",
                        "   - xsl: for XML transformations",
                        "   - zip: for package handling",
                        "5. Install composer with a pinned version using @composer-X.Y.Z syntax.",
                        "6. Install dev tools like Xdebug only in the development image.",
                        "7. Control Xdebug via environment variables (XDEBUG_MODE, XDEBUG_CLIENT_HOST, etc.).",
                        "8. Configure optimal PHP settings for development vs. production environments.",
                        "9. Move the production php.ini into place in the production image.",
                        "10. Configure opcache for production with:",
                        "    - opcache.validate_timestamps=0",
                        "    - opcache.memory_consumption=128",
                        "    - opcache.max_accelerated_files=10000",
                        "11. Install Symfony CLI only in the development image.",
                        "12. Use dumb-init to properly handle process signals in containerized PHP applications.",
                        "13. Implement a custom entrypoint that installs Composer and NPM dependencies if not present.",
                        "14. Mount custom PHP configuration files (like xdebug.ini) as read-only volumes.",
                        "15. Organize PHP configuration files in etc/docker/php/conf.d/ directory.",
                        "16. Set APP_ENV environment variable appropriately for each environment."
                    ],
                    "executable": false
                },
                "dockerignore": {
                    "contents": [
                        "**/.editorconfig",
                        "docs/",
                        "drivers/",
                        "node_modules/",
                        "npm-cache/",
                        "public/assets/",
                        "public/bundles/",
                        "public/themes/",
                        "tests/",
                        "var/",
                        "vendor/",
                        ".dockerignore",
                        ".env*",
                        "!.env",
                        "!.env.prod",
                        ".git*",
                        ".php*",
                        ".twig*",
                        "auth.json",
                        ""
                    ],
                    "executable": false
                },
                "etc/docker/entrypoints/app-entrypoint": {
                    "contents": [
                        "#!/bin/sh",
                        "set -e",
                        "",
                        "# Default command",
                        "if [ \"$#\" -eq 0 ]; then",
                        "  set -- bash",
                        "fi",
                        "",
                        "# Execute the command passed to the entrypoint",
                        "exec \"$@\""
                    ],
                    "executable": false
                },
                "etc/docker/entrypoints/app-php-entrypoint": {
                    "contents": [
                        "#!/bin/sh",
                        "set -e",
                        "",
                        "# Production",
                        "if [ \"$APP_ENV\" = \"prod\" ]; then",
                        "  bin/console cache:warmup",
                        "fi",
                        "",
                        "# Default command",
                        "if [ \"$#\" -eq 0 ]; then",
                        "  set -- dumb-init --rewrite 15:3 php-fpm",
                        "fi",
                        "",
                        "exec \"$@\""
                    ],
                    "executable": false
                },
                "etc/docker/php/conf.d/app.dev.ini": {
                    "contents": [
                        "; OPCache",
                        "; See: http://symfony.com/doc/current/performance.html",
                        "opcache.memory_consumption = 256",
                        "opcache.max_accelerated_files = 20000",
                        "",
                        "; Realpath Cache",
                        "; See: http://symfony.com/doc/current/performance.html",
                        "realpath_cache_size = 4096K",
                        "realpath_cache_ttl = 600",
                        "",
                        "; App",
                        "date.timezone = UTC",
                        "memory_limit = 256M"
                    ],
                    "executable": false
                },
                "etc/docker/php/conf.d/xdebug.ini": {
                    "contents": [
                        "[xdebug]",
                        "xdebug.mode=${XDEBUG_MODE}",
                        "xdebug.client_host=${XDEBUG_CLIENT_HOST}",
                        "xdebug.client_port=${XDEBUG_CLIENT_PORT}",
                        "xdebug.start_with_request=yes",
                        "xdebug.log=/tmp/xdebug.log",
                        "xdebug.idekey=PHPSTORM"
                    ],
                    "executable": false
                },
                "etc/docker/php/fpm.d/www.dev.conf": {
                    "contents": [
                        "[www]",
                        "",
                        "; 'user' and 'group' directives are ignored when FPM is not running as root",
                        "user =",
                        "group =",
                        "",
                        "; Choose how the process manager will control the number of child processes",
                        "pm = static",
                        "pm.max_children = 5"
                    ],
                    "executable": false
                }
            },
            "ref": "ab4e8a520909fd18eea61b9b04f683b83d337b68"
        }
    }
}
